#!/bin/sh
set -e

cd /app/discourse
for c in tmp:create db:migrate; do
  count=0; while [ "$count" -lt 4 ]; do
    set +e
    count=$(echo "$(($count+1))")
    if [ $count -gt 1 ]; then
      printf "\nRetrying\n"
    fi

    gosu discourse rake "$c" && break
    set -e
    sleep 6
  done

  if [ "$count" -gt 3 ]; then
    exit 1
  fi
done
