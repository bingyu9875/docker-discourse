#!/bin/bash
[ $DEBUG ] && set -x
set -e

if [ -z "$DISCOURSE_SMTP_ADDRESS" ] || [ -z "$DISCOURSE_DEVELOPER_EMAILS" ]; then
  echo "You have not setup SMTP or Developer Emails, please set them up."
  exit 1
fi

tail -qf /app/discourse/log/production.log &
touch /app/discourse/config/discourse.conf
chown discourse:discourse /app/discourse/config/discourse.conf
for v in $(printenv | grep -P '^DISCOURSE_' | grep -vE '^DISCOURSE_(VERSION|HOME|DATA)'); do
  echo $v | sed -r 's/^DISCOURSE_([^=]+)(.*)/\L\1\E\2/' >> \
    /app/discourse/config/discourse.conf
done
