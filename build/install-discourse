#!/bin/bash

set -e

[ $DEBUG ] && set -x

[ -f /tmp/build/env ] && source /tmp/build/env


groupadd -rg 200 discourse
useradd  -u  200 -g 200 -rMd /home/discourse discourse

mkdir /app && chown discourse:discourse /app -R && cd /app

curl -sLS -o /app/discourse.tar.gz  $DISCOURSE_URL && \
tar xzf /app/discourse.tar.gz && mv discourse-$DISCOURSE_VERSION discourse && \
rm -rf /app/discourse.tar.gz

cd /app/discourse

export BUNDLE_ARGS="-j128 --without=development:test --enable-shared" && \
bundle install


chown -R discourse:discourse /app/discourse

[ ! -d /app/discourse/log ] && gosu discourse mkdir -pv /app/discourse/log

for f in production.log unicorn.stderr.log unicorn.stdout.log
do
  [ ! -f /app/discourse/log/$f ] && touch /app/discourse/log/$f
done

chown discourse.discourse /app/discourse/log/*

for c in assets:precompile assets:clean uploads:clean_up avatars:clean; do
  count=0; while [ "$count" -lt 4 ]; do
    set +e
    count=$(echo "$(($count+1))")
    if [ $count -gt 1 ]; then
      printf "\nRetrying\n"
    fi

    gosu discourse rake "$c" && break
    set -e
    sleep 6
  done

  if [ "$count" -gt 3 ]; then
    exit 1
  fi
done
